"use strict";(()=>{var e={};e.id=294,e.ids=[294],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5315:e=>{e.exports=require("path")},8926:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var i={};a.r(i),a.d(i,{POST:()=>d});var o=a(9182),n=a(2007),s=a(6719),r=a(3524),c=a(7639),l=a(4761);let p=new r.PrismaClient;async function d(e){let t=new TextEncoder;return new Response(new ReadableStream({async start(e){try{await p.processingJob.create({data:{status:"processing",progress:0,message:"Starting organization..."}}),e.enqueue(t.encode(`data: ${JSON.stringify({status:"processing",progress:5,message:"Loading files..."})}

`));let a=await p.fileRecord.findMany({where:{organizationId:null,isDeleted:!1}});if(0===a.length){e.enqueue(t.encode(`data: ${JSON.stringify({status:"completed",result:{id:"no-files",name:"No Files to Organize",description:"No unorganized files found",status:"completed",filesProcessed:0,totalFiles:0,beforeSnapshot:[],afterSnapshot:[],createdAt:new Date,isUndone:!1}})}

`)),e.enqueue(t.encode(`data: [DONE]

`)),e.close();return}let i=await p.organization.create({data:{name:`Organization ${new Date().toLocaleDateString()}`,description:`Organized ${a.length} files`,status:"processing",totalFiles:a.length,filesProcessed:0,beforeSnapshot:JSON.stringify(a.map(e=>({name:e.originalName,originalName:e.originalName,path:e.originalPath,size:e.fileSize,type:e.fileType,mimeType:e.mimeType,lastModified:e.uploadedAt,category:e.category}))),afterSnapshot:JSON.stringify([])}}),o=0,n=[];for(let s of a)try{let r=Math.floor(o/a.length*80)+10;e.enqueue(t.encode(`data: ${JSON.stringify({status:"processing",progress:r,message:`Processing ${s.originalName}...`})}

`));let d=await u({fileName:s.originalName,fileType:s.fileType,mimeType:s.mimeType,fileSize:s.fileSize}),g=(0,l.He)(d.suggestedName||s.originalName),m=await (0,c.f_)(s.currentPath,d.category,d.subcategory,g);await p.fileRecord.update({where:{id:s.id},data:{currentPath:m,currentName:g,category:d.category,subcategory:d.subcategory,tags:JSON.stringify(d.tags),organizationId:i.id}}),n.push({name:g,originalName:s.originalName,path:m,size:s.fileSize,type:s.fileType,mimeType:s.mimeType,lastModified:s.uploadedAt,category:d.category,subcategory:d.subcategory,tags:d.tags}),o++}catch(e){console.error(`Error processing file ${s.originalName}:`,e)}let s=await p.organization.update({where:{id:i.id},data:{status:"completed",filesProcessed:o,afterSnapshot:JSON.stringify(n)},include:{files:!0}});e.enqueue(t.encode(`data: ${JSON.stringify({status:"completed",result:{id:s.id,name:s.name,description:s.description||"",status:s.status,filesProcessed:s.filesProcessed,totalFiles:s.totalFiles,beforeSnapshot:JSON.parse(s.beforeSnapshot),afterSnapshot:JSON.parse(s.afterSnapshot),createdAt:s.createdAt,isUndone:s.isUndone}})}

`)),e.enqueue(t.encode(`data: [DONE]

`))}catch(a){console.error("Organization error:",a),e.enqueue(t.encode(`data: ${JSON.stringify({status:"error",message:"Organization failed"})}

`))}finally{await p.$disconnect(),e.close()}}}),{headers:{"Content-Type":"text/plain; charset=utf-8","Cache-Control":"no-cache",Connection:"keep-alive"}})}async function u(e){try{let t=[{role:"user",content:`Please analyze this file and provide classification information in JSON format:

Filename: ${e.fileName}
File Type: ${e.fileType}
MIME Type: ${e.mimeType}
File Size: ${e.fileSize} bytes

Please respond in JSON format with the following structure:
{
  "category": "Category name (Images, Documents, PDFs, Videos, Audio, etc.)",
  "subcategory": "More specific category (optional)",
  "suggestedName": "Improved filename if needed",
  "tags": ["tag1", "tag2", "tag3"],
  "confidence": 0.95,
  "reasoning": "Brief explanation of classification"
}

Available categories: Images, Documents, PDFs, Spreadsheets, Presentations, Videos, Audio, Archives, Code, Other

Respond with raw JSON only. Do not include code blocks, markdown, or any other formatting.`}],a=await fetch("https://apps.abacus.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.ABACUSAI_API_KEY}`},body:JSON.stringify({model:"gpt-4.1-mini",messages:t,response_format:{type:"json_object"},max_tokens:1e3})});if(!a.ok)throw Error("AI classification failed");let i=await a.json(),o=i.choices?.[0]?.message?.content;if(!o)throw Error("No content in AI response");let n=JSON.parse(o);return{category:n.category||"Other",subcategory:n.subcategory||"",suggestedName:n.suggestedName||e.fileName,tags:n.tags||[],confidence:n.confidence||.5,reasoning:n.reasoning||"Auto-classified based on file type"}}catch(a){console.error("AI classification error:",a);let t="Other";return e.mimeType.startsWith("image/")?t="Images":e.mimeType.startsWith("video/")?t="Videos":e.mimeType.startsWith("audio/")?t="Audio":e.mimeType.includes("pdf")?t="PDFs":(e.mimeType.includes("document")||e.mimeType.includes("text"))&&(t="Documents"),{category:t,subcategory:"",suggestedName:e.fileName,tags:[e.fileType],confidence:.3,reasoning:"Fallback classification due to AI error"}}}let g=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/organize/route",pathname:"/api/organize",filename:"route",bundlePath:"app/api/organize/route"},resolvedPagePath:"/home/ubuntu/thanos_file_organizer/app/app/api/organize/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:y}=g,h="/api/organize/route";function w(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},7639:(e,t,a)=>{a.d(t,{BR:()=>g,f_:()=>d,Fk:()=>u,Ho:()=>p});let i=require("fs/promises");var o=a.n(i),n=a(5315),s=a.n(n);let r=s().join(process.cwd(),"uploads"),c=s().join(process.cwd(),"uploads","organized");async function l(){try{await o().mkdir(r,{recursive:!0}),await o().mkdir(c,{recursive:!0})}catch(e){console.error("Error creating directories:",e)}}async function p(e,t){await l();let a=Buffer.from(await e.arrayBuffer()),i=s().join(r,t);return await o().writeFile(i,a),i}async function d(e,t,a,i){let n=a?s().join(c,t,a):s().join(c,t);await o().mkdir(n,{recursive:!0});let r=s().join(n,i);return await o().copyFile(e,r),r}async function u(e,t){await o().copyFile(e,t)}async function g(e){try{let t=await o().stat(e),a=s().basename(e);return{name:a,originalName:a,path:e,size:t.size,type:s().extname(a).slice(1).toLowerCase(),mimeType:({".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".gif":"image/gif",".webp":"image/webp",".svg":"image/svg+xml",".pdf":"application/pdf",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".txt":"text/plain",".csv":"text/csv",".mp4":"video/mp4",".mp3":"audio/mpeg",".wav":"audio/wav",".zip":"application/zip"})[s().extname(a).toLowerCase()]||"application/octet-stream",lastModified:t.mtime}}catch(e){return console.error("Error getting file stats:",e),null}}},4761:(e,t,a)=>{a.d(t,{He:()=>r,T2:()=>s,cn:()=>n});var i=a(1862),o=a(2703);function n(...e){return(0,o.m6)((0,i.W)(e))}function s(e){return e.startsWith("image/")?"Images":e.startsWith("video/")?"Videos":e.startsWith("audio/")?"Audio":e.includes("pdf")?"PDFs":e.includes("document")||e.includes("msword")||e.includes("wordprocessing")?"Documents":e.includes("sheet")||e.includes("excel")||e.includes("csv")?"Spreadsheets":e.includes("presentation")||e.includes("powerpoint")?"Presentations":e.includes("text")?"Text Files":e.includes("zip")||e.includes("rar")||e.includes("tar")||e.includes("gzip")?"Archives":"Other"}function r(e){return e.replace(/[^a-zA-Z0-9.-]/g,"_").replace(/_+/g,"_")}},9182:(e,t,a)=>{e.exports=a(517)}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[412,255],()=>a(8926));module.exports=i})();